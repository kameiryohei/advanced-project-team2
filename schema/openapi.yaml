openapi: 3.0.3
info:
  title: 先進プロジェクト実験 Team2 避難所 API
  version: "1.0.0"
tags:
  - name: 避難所
    description: 避難所情報を取得するAPI
  - name: 投稿
    description: 投稿やコメントを作成・取得するAPI
  - name: ジオコーディング
    description: 位置情報に関連する補助API
servers:
  - url: http://localhost:8787
paths:
  /api/geocode/reverse:
    get:
      tags:
        - ジオコーディング
      summary: 緯度・経度から住所を取得
      description: Yahoo!地図APIの逆ジオコーダを呼び出し、住所と補助情報を返します。
      parameters:
        - name: lat
          in: query
          required: true
          description: 検索対象の緯度
          schema:
            type: number
            format: float
        - name: lon
          in: query
          required: true
          description: 検索対象の経度
          schema:
            type: number
            format: float
      responses:
        "200":
          description: 住所を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReverseGeocoderResponse"
        "400":
          description: 緯度または経度が不足しています
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 住所が見つかりませんでした
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー内またはYahoo! APIへの問い合わせでエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /posts:
    post:
      tags:
        - 投稿
      summary: 投稿を新規作成
      description: 避難所の状況を投稿し、必要に応じて災害発生時刻・位置情報の時系列データ・メディアファイル情報を添付します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePostRequest"
      responses:
        "201":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "400":
          description: リクエスト内容が不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters:
    get:
      tags:
        - 避難所
      summary: 避難所一覧を取得
      responses:
        "200":
          description: 避難所一覧を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterListWithCountResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters/{id}:
    get:
      tags:
        - 避難所
      summary: 避難所の詳細を取得
      parameters:
        - name: id
          in: path
          required: true
          description: 避難所ID
          schema:
            type: integer
      responses:
        "200":
          description: 避難所の詳細を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterDetails"
        "400":
          description: 不正な避難所IDが指定されました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters/{id}/posts:
    get:
      tags:
        - 避難所
      summary: 指定した避難所の最新投稿を取得
      parameters:
        - name: id
          in: path
          required: true
          description: 避難所ID
          schema:
            type: integer
      responses:
        "200":
          description: 最新の投稿一覧を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterPostsResponse"
        "400":
          description: 不正な避難所IDが指定されました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /posts/{id}/comments:
    post:
      tags:
        - 投稿
      summary: コメントを新規投稿
      parameters:
        - name: id
          in: path
          required: true
          description: コメント対象の投稿ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCommentRequest"
      responses:
        "201":
          description: コメントを作成しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateCommentResponse"
        "400":
          description: リクエスト内容が不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 対象の投稿が見つかりません
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    CreatePostRequest:
      type: object
      properties:
        shelterId:
          type: integer
          description: 投稿対象の避難所ID
        authorName:
          type: string
          description: 投稿者の表示名
        content:
          type: string
          nullable: true
          description: 投稿本文
        occurredAt:
          type: string
          format: date-time
          nullable: true
          description: 災害等の事象が発生した時刻
        status:
          type: string
          nullable: true
          description: 現在の状況ステータス
          enum:
            - 緊急
            - 重要
            - 通常
        locationTrack:
          type: array
          description: 動画撮影などに合わせて取得した位置情報の時系列データ
          items:
            $ref: "#/components/schemas/LocationTrackPoint"
        media:
          type: array
          description: 添付するメディア情報
          items:
            $ref: "#/components/schemas/PostMediaItem"
      required:
        - authorName
        - shelterId
    LocationTrackPoint:
      type: object
      properties:
        recordedAt:
          type: string
          format: date-time
          description: 位置情報を取得した時刻
        latitude:
          type: number
          format: float
          description: 緯度
        longitude:
          type: number
          format: float
          description: 経度
      required:
        - recordedAt
        - latitude
        - longitude
    PostMediaItem:
      type: object
      properties:
        mediaType:
          type: string
          description: MIMEタイプ
        fileName:
          type: string
          nullable: true
          description: メディア表示名
      required:
        - mediaType
    OkResponse:
      type: object
      properties:
        message:
          type: string
          description: 処理結果の簡易メッセージ
          example: OK
      required:
        - message
    CreateCommentRequest:
      type: object
      properties:
        authorName:
          type: string
          description: コメント投稿者の表示名
        content:
          type: string
          description: コメント本文
      required:
        - authorName
        - content
    CreateCommentResponse:
      type: object
      properties:
        comment:
          type: object
          properties:
            id:
              type: string
              description: コメントID
            postId:
              type: string
              description: 紐づく投稿ID
            authorName:
              type: string
              description: コメント投稿者の表示名
            content:
              type: string
              description: コメント本文
            createdAt:
              type: string
              format: date-time
              description: コメントの作成時刻
          required:
            - id
            - postId
            - authorName
            - content
            - createdAt
      required:
        - comment
    ShelterListWithCountResponse:
      type: object
      properties:
        shelterCount:
          type: integer
          description: 登録されている避難所の総数
        shelterList:
          type: array
          description: 避難所の一覧
          items:
            $ref: "#/components/schemas/ShelterSummary"
      required:
        - shelterCount
        - shelterList
    ShelterSummary:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
      required:
        - id
        - name
    ShelterDetails:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        address:
          type: string
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - address
        - latitude
        - longitude
        - created_at
    ShelterPostsResponse:
      type: object
      properties:
        shelterId:
          type: integer
        posts:
          type: array
          items:
            $ref: "#/components/schemas/ShelterPost"
      required:
        - shelterId
        - posts
    ShelterPost:
      type: object
      properties:
        id:
          type: string
        author_name:
          type: string
        content:
          type: string
          nullable: true
        posted_at:
          type: string
          format: date-time
        shelter_name:
          type: string
        comment_count:
          type: integer
      required:
        - id
        - author_name
        - posted_at
        - shelter_name
        - comment_count
    ReverseGeocoderResponse:
      type: object
      description: Yahoo!地図API 逆ジオコーダのレスポンス（Feature 配列）。
      properties:
        Feature:
          type: array
          description: 位置情報にマッチした候補の一覧
          items:
            $ref: "#/components/schemas/ReverseGeocoderFeature"
      required:
        - Feature
    ReverseGeocoderFeature:
      type: object
      properties:
        Name:
          type: string
          description: この候補の代表名称（住所など）
        Geometry:
          $ref: "#/components/schemas/ReverseGeocoderGeometry"
        Property:
          $ref: "#/components/schemas/ReverseGeocoderProperty"
      required:
        - Name
        - Geometry
        - Property
    ReverseGeocoderGeometry:
      type: object
      properties:
        Coordinates:
          type: string
          description: "経度,緯度 の文字列（CSV形式）"
        Type:
          type: string
          description: Geometryの種類（通常はPoint）
        BoundingBox:
          type: string
          nullable: true
          description: 逆ジオコーダが使用した範囲（左下,右上）
      required:
        - Coordinates
        - Type
    ReverseGeocoderProperty:
      type: object
      properties:
        Address:
          type: string
          description: 返却された住所テキスト
        Country:
          type: string
          nullable: true
        Prefecture:
          type: string
          nullable: true
        City:
          type: string
          nullable: true
        Town:
          type: string
          nullable: true
        Street:
          type: string
          nullable: true
        Postal:
          type: string
          nullable: true
        MatchCode:
          type: string
          nullable: true
        MatchLevel:
          type: string
          nullable: true
        AddressElement:
          type: array
          description: 住所の階層ごとの要素
          items:
            $ref: "#/components/schemas/ReverseGeocoderAddressElement"
      required:
        - Address
    ReverseGeocoderAddressElement:
      type: object
      properties:
        Name:
          type: string
          description: 要素の名前（例:Country, City）
        NameCode:
          type: string
          nullable: true
        Value:
          type: string
          description: 要素に対応する値
      required:
        - Name
        - Value
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required:
        - error
