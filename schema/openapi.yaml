openapi: 3.0.3
info:
  title: 先進プロジェクト実験 Team2 避難所 API
  version: "1.0.0"
tags:
  - name: 避難所
    description: 避難所情報を取得するAPI
  - name: 投稿
    description: 投稿やコメントを作成・取得するAPI
  - name: ジオコーディング
    description: 位置情報に関連する補助API
  - name: 同期
    description: ローカルDBと本番DBのデータ同期API
servers:
  - url: http://localhost:8787
paths:
  /api/geocode/reverse:
    get:
      tags:
        - ジオコーディング
      summary: 緯度・経度から住所を取得
      description: Yahoo!地図APIの逆ジオコーダを呼び出し、住所と補助情報を返します。
      parameters:
        - name: lat
          in: query
          required: true
          description: 検索対象の緯度
          schema:
            type: number
            format: float
        - name: lon
          in: query
          required: true
          description: 検索対象の経度
          schema:
            type: number
            format: float
      responses:
        "200":
          description: 住所を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReverseGeocoderResponse"
        "400":
          description: 緯度または経度が不足しています
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 住所が見つかりませんでした
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー内またはYahoo! APIへの問い合わせでエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  # 同期API
  /api/sync/status:
    get:
      tags:
        - 同期
      summary: 同期ステータスを取得
      description: 未同期データの統計情報を取得します。
      responses:
        "200":
          description: 同期ステータスを取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncStatusResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/sync/execute:
    post:
      tags:
        - 同期
      summary: 同期を実行
      description: ローカルDBの未同期データを本番DBに同期します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncExecuteRequest"
      responses:
        "200":
          description: 同期を実行しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncExecuteResponse"
        "400":
          description: リクエストが不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/sync/receive:
    post:
      tags:
        - 同期
      summary: 同期データを受信
      description: 他の環境からの同期データを受信してDBに保存します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncReceiveRequest"
      responses:
        "200":
          description: 同期データを受信・保存しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncReceiveResponse"
        "500":
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /posts:
    post:
      tags:
        - 投稿
      summary: 投稿を新規作成（メディア同梱）
      description: 本文・時刻・位置トラックなどのメタデータと、画像/動画ファイルを同梱して投稿します。
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                metadata:
                  $ref: "#/components/schemas/CreatePostRequest"
                mediaFiles:
                  type: array
                  description: 添付するメディアファイル（画像/動画）
                  items:
                    type: string
                    format: binary
              required:
                - metadata
            encoding:
              metadata:
                contentType: application/json
              mediaFiles:
                contentType: image/*, video/*
            examples:
              with-media:
                summary: 位置情報やメディアを含む投稿例
                value:
                  metadata:
                    shelterId: 101
                    authorName: 事例太郎
                    content: 避難所周囲の状況は落ち着いていますが、引き続き注意が必要です。
                    occurredAt: 2024-06-26T18:30:00Z
                    status: 未対応
                    locationTrack:
                      - recordedAt: 2024-06-26T18:20:00Z
                        latitude: 35.6895
                        longitude: 139.6917
                      - recordedAt: 2024-06-26T18:25:00Z
                        latitude: 35.6896
                        longitude: 139.6920
                  # mediaFiles は実ファイル（例：evac_situation.jpg, report.mp4）を form-data で複数添付
      responses:
        "201":
          description: 投稿を作成しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreatePostResponse"
        "400":
          description: リクエスト内容が不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "413":
          description: ファイルサイズが許容上限を超えています
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "415":
          description: 未対応の Content-Type（MIME）です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /posts/{id}:
    get:
      tags:
        - 投稿
      summary: 投稿の詳細を取得
      description: 指定した投稿IDの詳細情報（メディアURL含む）を取得します。
      parameters:
        - name: id
          in: path
          required: true
          description: 投稿ID
          schema:
            type: string
      responses:
        "200":
          description: 投稿の詳細を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PostDetailResponse"
        "404":
          description: 投稿が見つかりません
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters:
    get:
      tags:
        - 避難所
      summary: 避難所一覧を取得
      responses:
        "200":
          description: 避難所一覧を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterListWithCountResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters/{id}:
    get:
      tags:
        - 避難所
      summary: 避難所の詳細を取得
      parameters:
        - name: id
          in: path
          required: true
          description: 避難所ID
          schema:
            type: integer
      responses:
        "200":
          description: 避難所の詳細を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterDetails"
        status:
          type: string
          nullable: true
          description: 現在の状況ステータス
          enum:
            - 緊急
            - 重要
            - 通常
        "400":
          description: 不正な避難所IDが指定されました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /shelters/{id}/posts:
    get:
      tags:
        - 避難所
      summary: 指定した避難所の最新投稿を取得
      parameters:
        - name: id
          in: path
          required: true
          description: 避難所ID
          schema:
            type: integer
      responses:
        "200":
          description: 最新の投稿一覧を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShelterPostsResponse"
        "400":
          description: 不正な避難所IDが指定されました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: データベースのクエリに失敗しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /posts/{id}/comments:
    get:
      tags:
        - 投稿
      summary: 投稿に紐づくコメント一覧を取得
      parameters:
        - name: id
          in: path
          required: true
          description: 対象の投稿ID
          schema:
            type: string
        - name: isFreeChat
          in: query
          required: false
          description: フリーチャット投稿の場合は `true` を指定し、関連コメント取得をスキップします
          schema:
            type: boolean
      responses:
        "200":
          description: コメント一覧を取得しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PostCommentsResponse"
        "400":
          description: リクエスト内容が不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags:
        - 投稿
      summary: コメントを新規投稿
      parameters:
        - name: id
          in: path
          required: true
          description: コメント対象の投稿ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCommentRequest"
      responses:
        "201":
          description: コメントを作成しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateCommentResponse"
        "400":
          description: リクエスト内容が不正です
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 対象の投稿が見つかりません
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: サーバー側でエラーが発生しました
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    CreatePostRequest:
      type: object
      properties:
        shelterId:
          type: integer
          description: 投稿対象の避難所ID
        authorName:
          type: string
          description: 投稿者の表示名
        content:
          type: string
          nullable: true
          description: 投稿本文
        occurredAt:
          type: string
          format: date-time
          nullable: true
          description: 災害等の事象が発生した時刻
        status:
          type: string
          nullable: true
          description: 現在の状況ステータス
          enum:
            - 緊急
            - 重要
            - 通常
        locationTrack:
          type: array
          description: 動画撮影などに合わせて取得した位置情報の時系列データ
          items:
            $ref: "#/components/schemas/LocationTrackPoint"
        media:
          type: array
          description: 添付するメディア情報
          items:
            $ref: "#/components/schemas/PostMediaItem"
      required:
        - authorName
        - shelterId
    LocationTrackPoint:
      type: object
      properties:
        recordedAt:
          type: string
          format: date-time
          description: 位置情報を取得した時刻
        latitude:
          type: number
          format: float
          description: 緯度
        longitude:
          type: number
          format: float
          description: 経度
      required:
        - recordedAt
        - latitude
        - longitude
    PostMediaItem:
      type: object
      properties:
        mediaType:
          type: string
          description: MIMEタイプ
        fileName:
          type: string
          nullable: true
          description: メディア表示名
      required:
        - mediaType
    CreatePostResponse:
      type: object
      description: 投稿作成後のレスポンス
      properties:
        postId:
          type: string
          description: 作成された投稿のID
        media:
          type: array
          description: アップロードされたメディア情報
          items:
            $ref: "#/components/schemas/MediaItem"
      required:
        - postId
        - media
    MediaItem:
      type: object
      description: メディアファイル情報
      properties:
        mediaId:
          type: string
          description: メディアID
        mediaType:
          type: string
          description: MIMEタイプ
        fileName:
          type: string
          nullable: true
          description: 元のファイル名
        url:
          type: string
          description: メディアにアクセスするURL
      required:
        - mediaId
        - mediaType
        - url
    PostDetailResponse:
      type: object
      description: 投稿詳細情報
      properties:
        id:
          type: string
          description: 投稿ID
        shelterId:
          type: integer
          description: 避難所ID
        shelterName:
          type: string
          description: 避難所名
        authorName:
          type: string
          description: 投稿者の表示名
        content:
          type: string
          nullable: true
          description: 投稿本文
        occurredAt:
          type: string
          format: date-time
          nullable: true
          description: 災害等の事象が発生した時刻
        postedAt:
          type: string
          format: date-time
          description: 投稿された時刻
        status:
          type: string
          nullable: true
          description: 現在の状況ステータス
          enum:
            - 緊急
            - 重要
            - 通常
        media:
          type: array
          description: 添付されたメディア情報
          items:
            $ref: "#/components/schemas/MediaItem"
        locationTrack:
          type: array
          description: 位置情報の時系列データ
          items:
            $ref: "#/components/schemas/LocationTrackPoint"
        commentCount:
          type: integer
          description: コメント数
      required:
        - id
        - shelterId
        - authorName
        - postedAt
        - media
        - commentCount
    OkResponse:
      type: object
      properties:
        message:
          type: string
          description: 処理結果の簡易メッセージ
          example: OK
      required:
        - message
    CreateCommentRequest:
      type: object
      properties:
        authorName:
          type: string
          description: コメント投稿者の表示名
        content:
          type: string
          description: コメント本文
        status:
          type: string
          nullable: true
          description: コメントに紐づく状況ステータス
          enum:
            - 未対応
            - 対応中
            - 対応済み
      required:
        - authorName
        - content
    CreateCommentResponse:
      type: object
      properties:
        comment:
          type: object
          properties:
            id:
              type: string
              description: コメントID
            postId:
              type: string
              description: 紐づく投稿ID
            authorName:
              type: string
              description: コメント投稿者の表示名
            content:
              type: string
              description: コメント本文
            createdAt:
              type: string
              format: date-time
              description: コメントの作成時刻
            status:
              type: string
              nullable: true
              description: コメントに紐づく状況ステータス
              enum:
                - 未対応
                - 対応中
                - 対応済み
          required:
            - id
            - postId
            - authorName
            - content
            - createdAt
      required:
        - comment
    PostComment:
      type: object
      properties:
        id:
          type: string
          description: コメントID
        authorName:
          type: string
          description: コメント投稿者の表示名
        content:
          type: string
          description: コメント本文
        createdAt:
          type: string
          format: date-time
          description: コメントの作成時刻
        status:
          type: string
          nullable: true
          description: コメントに紐づく状況ステータス
          enum:
            - 未対応
            - 対応中
            - 対応済み
      required:
        - id
        - authorName
        - content
        - createdAt
    PostCommentsResponse:
      type: object
      properties:
        postId:
          type: string
          description: 対象の投稿ID
        status:
          type: string
          description: 現在の状況ステータス
          nullable: true
          enum:
            - 緊急
            - 重要
            - 通常
        isFreeChat:
          type: boolean
          description: 対象の投稿がフリーチャットの場合は true
        comments:
          type: array
          description: コメント一覧
          items:
            $ref: "#/components/schemas/PostComment"
      required:
        - postId
        - comments
    ShelterListWithCountResponse:
      type: object
      properties:
        shelterCount:
          type: integer
          description: 登録されている避難所の総数
        shelterList:
          type: array
          description: 避難所の一覧
          items:
            $ref: "#/components/schemas/ShelterSummary"
      required:
        - shelterCount
        - shelterList
    ShelterSummary:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        address:
          type: string
          nullable: true
        latitude:
          type: number
          format: float
          nullable: true
        longitude:
          type: number
          format: float
          nullable: true
      required:
        - id
        - name
    ShelterDetails:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        address:
          type: string
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - address
        - latitude
        - longitude
        - created_at
    ShelterPostsResponse:
      type: object
      properties:
        shelterId:
          type: integer
        posts:
          type: array
          items:
            $ref: "#/components/schemas/ShelterPost"
      required:
        - shelterId
        - posts
    ShelterPost:
      type: object
      properties:
        id:
          type: string
        author_name:
          type: string
        content:
          type: string
          nullable: true
        posted_at:
          type: string
          format: date-time
        address:
          type: string
          nullable: true
        comment_count:
          type: integer
        status:
          type: string
          nullable: true
          description: 現在の状況ステータス
          enum:
            - 緊急
            - 重要
            - 通常
      required:
        - id
        - author_name
        - posted_at
        - comment_count
    ReverseGeocoderResponse:
      type: object
      description: Yahoo!地図API 逆ジオコーダのレスポンス（Feature 配列）。
      properties:
        Feature:
          type: array
          description: 位置情報にマッチした候補の一覧
          items:
            $ref: "#/components/schemas/ReverseGeocoderFeature"
      required:
        - Feature
    ReverseGeocoderFeature:
      type: object
      properties:
        Name:
          type: string
          description: この候補の代表名称（住所など）
        Geometry:
          $ref: "#/components/schemas/ReverseGeocoderGeometry"
        Property:
          $ref: "#/components/schemas/ReverseGeocoderProperty"
      required:
        - Name
        - Geometry
        - Property
    ReverseGeocoderGeometry:
      type: object
      properties:
        Coordinates:
          type: string
          description: "経度,緯度 の文字列（CSV形式）"
        Type:
          type: string
          description: Geometryの種類（通常はPoint）
        BoundingBox:
          type: string
          nullable: true
          description: 逆ジオコーダが使用した範囲（左下,右上）
      required:
        - Coordinates
        - Type
    ReverseGeocoderProperty:
      type: object
      properties:
        Address:
          type: string
          description: 返却された住所テキスト
        Country:
          type: string
          nullable: true
        Prefecture:
          type: string
          nullable: true
        City:
          type: string
          nullable: true
        Town:
          type: string
          nullable: true
        Street:
          type: string
          nullable: true
        Postal:
          type: string
          nullable: true
        MatchCode:
          type: string
          nullable: true
        MatchLevel:
          type: string
          nullable: true
        AddressElement:
          type: array
          description: 住所の階層ごとの要素
          items:
            $ref: "#/components/schemas/ReverseGeocoderAddressElement"
      required:
        - Address
    ReverseGeocoderAddressElement:
      type: object
      properties:
        Name:
          type: string
          description: 要素の名前（例:Country, City）
        NameCode:
          type: string
          nullable: true
        Value:
          type: string
          description: 要素に対応する値
      required:
        - Name
        - Value
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required:
        - error

    # 同期関連のスキーマ
    SyncStatusResponse:
      type: object
      description: 同期ステータスのレスポンス
      properties:
        unsyncedPosts:
          type: integer
          description: 未同期の投稿数
        unsyncedComments:
          type: integer
          description: 未同期のコメント数
        unsyncedLocationTracks:
          type: integer
          description: 未同期の位置情報トラック数
        totalUnsynced:
          type: integer
          description: 未同期データの合計数
        lastSyncAt:
          type: string
          format: date-time
          nullable: true
          description: 最後に同期した日時
        lastSyncStatus:
          type: string
          nullable: true
          description: 最後の同期ステータス
      required:
        - unsyncedPosts
        - unsyncedComments
        - unsyncedLocationTracks
        - totalUnsynced

    SyncExecuteRequest:
      type: object
      description: 同期実行リクエスト
      properties:
        targetUrl:
          type: string
          description: 同期先のAPI URL
      required:
        - targetUrl

    SyncExecuteResponse:
      type: object
      description: 同期実行レスポンス
      properties:
        success:
          type: boolean
          description: 同期が成功したかどうか
        postsSynced:
          type: integer
          description: 同期した投稿数
        commentsSynced:
          type: integer
          description: 同期したコメント数
        locationTracksSynced:
          type: integer
          description: 同期した位置情報トラック数
        message:
          type: string
          nullable: true
          description: 追加のメッセージ
        error:
          type: string
          nullable: true
          description: エラーメッセージ（失敗時）
      required:
        - success
        - postsSynced
        - commentsSynced
        - locationTracksSynced

    SyncReceiveRequest:
      type: object
      description: 同期データ受信リクエスト
      properties:
        posts:
          type: array
          description: 同期する投稿データ
          items:
            $ref: "#/components/schemas/UnsyncedPost"
        comments:
          type: array
          description: 同期するコメントデータ
          items:
            $ref: "#/components/schemas/UnsyncedComment"
        locationTracks:
          type: array
          description: 同期する位置情報トラックデータ
          items:
            $ref: "#/components/schemas/UnsyncedLocationTrack"
        sourceUrl:
          type: string
          nullable: true
          description: 同期元のURL
      required:
        - posts
        - comments
        - locationTracks

    SyncReceiveResponse:
      type: object
      description: 同期データ受信レスポンス
      properties:
        success:
          type: boolean
          description: 受信・保存が成功したかどうか
        postsSynced:
          type: integer
          description: 保存した投稿数
        commentsSynced:
          type: integer
          description: 保存したコメント数
        locationTracksSynced:
          type: integer
          description: 保存した位置情報トラック数
        error:
          type: string
          nullable: true
          description: エラーメッセージ（失敗時）
      required:
        - success
        - postsSynced
        - commentsSynced
        - locationTracksSynced

    UnsyncedPost:
      type: object
      description: 未同期の投稿データ
      properties:
        id:
          type: string
        author_name:
          type: string
        shelter_id:
          type: integer
        content:
          type: string
          nullable: true
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        posted_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_free_chat:
          type: integer
        status:
          type: string
          nullable: true
      required:
        - id
        - author_name
        - shelter_id
        - latitude
        - longitude
        - posted_at
        - created_at
        - updated_at
        - is_free_chat

    UnsyncedComment:
      type: object
      description: 未同期のコメントデータ
      properties:
        id:
          type: string
        post_id:
          type: string
        author_name:
          type: string
        content:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - post_id
        - author_name
        - content
        - status
        - created_at
        - updated_at

    UnsyncedLocationTrack:
      type: object
      description: 未同期の位置情報トラックデータ
      properties:
        id:
          type: string
        post_id:
          type: string
        recorded_at:
          type: string
          format: date-time
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - post_id
        - recorded_at
        - latitude
        - longitude
        - created_at
        - updated_at
